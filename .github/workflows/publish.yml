name: publish-to-github-pages
on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸ - Cache dependencies âš¡ - Install dependencies ðŸ”§
        uses: ./.github/workflows/setup-node

      - name: Setup Pages âš™ï¸
        uses: actions/configure-pages@v4
        with:
          static_site_generator: next

      - name: Check Next.js config ðŸ”
        run: |
          echo "Checking Next.js configuration files:"
          ls -la next.config.* || echo "No next.config files found"
          if [ -f "next.config.ts" ]; then
            echo "next.config.ts contents:"
            cat next.config.ts
          fi
          if [ -f "next.config.js" ]; then
            echo "next.config.js contents:"
            cat next.config.js
          fi

      - name: Build with Next.js ðŸ—ï¸
        run: |
          echo "Building Next.js app..."
          npm run build 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT_CODE"
          echo ""
          echo "Checking build artifacts:"
          if [ -d ".next/build" ]; then
            echo ".next/build exists:"
            ls -la .next/build | head -10
            echo ""
            echo "Checking for HTML files in .next/build:"
            find .next/build -name "*.html" | head -5
          fi
          if [ -f ".next/export-marker.json" ]; then
            echo "Export marker found:"
            cat .next/export-marker.json
          fi
          echo ""
          echo "Checking if out directory was created:"
          if [ -d "./out" ]; then
            echo "âœ“ out directory exists!"
            ls -la ./out | head -10
          else
            echo "âš  out directory does not exist (will be handled in next step)"
          fi
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "Build failed with exit code $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
          fi
        env:
          NEXT_PRIVATE_STANDALONE: false
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Prepare export directory ðŸ“‹
        run: |
          echo "Checking for output directory..."
          if [ -d "./out" ]; then
            echo "âœ“ ./out directory exists"
            echo "Contents:"
            ls -la ./out | head -20
            echo "File count:"
            find ./out -type f | wc -l
          elif [ -d "./.next/build" ]; then
            echo "âš  ./out directory does not exist, but .next/build directory found"
            echo "This suggests the export step didn't complete, but we can use .next/build"
            echo ""
            echo "Checking .next/build structure:"
            find .next/build -type f -name "*.html" | head -10
            echo ""
            echo "Creating out directory from .next/build..."
            mkdir -p out
            # Copy all files from .next/build to out
            cp -r .next/build/* out/ 2>&1
            if [ -d "./out" ] && [ "$(ls -A ./out 2>/dev/null)" ]; then
              echo "âœ“ Successfully created out directory from .next/build"
              ls -la ./out | head -20
            else
              echo "âœ— Failed to create out directory"
              echo ""
              echo "Checking for any error logs:"
              if [ -f "build.log" ]; then
                echo "Last 50 lines of build log:"
                tail -50 build.log
              fi
              exit 1
            fi
          else
            echo "Error: Neither ./out nor ./.next/build directory found"
            echo "Build output contents:"
            ls -la
            exit 1
          fi

      - name: Upload artifact ðŸ“¡
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Publish to GitHub Pages ðŸš€
        id: deployment
        uses: actions/deploy-pages@v4